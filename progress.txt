## Codebase Patterns
- Edge functions live in `functions/<function-name>/index.ts` (Supabase Edge Functions use Deno)
- Edge function config goes in `supabase/config.toml` under `[functions.<name>]` with `verify_jwt` setting
- Use `https://deno.land/std@0.168.0/http/server.ts` serve() and `https://esm.sh/@supabase/supabase-js@2` createClient()
- Always include CORS headers and OPTIONS preflight handler in edge functions
- `functions/sitemap.xml.ts` is a Cloudflare Pages function, NOT a Supabase edge function
- Template patterns available in `edge-functions-template/functions/` for reference
- TypeScript check: `npx tsc --noEmit`, Tests: `npx vitest run` (382 passing)
- Test files follow pattern: `src/**/*.test.{ts,tsx}` alongside source files
- Mock Supabase client in tests by mocking `@/integrations/supabase/client`
- Auth page tests need AppProvider wrapper and mocks for: logger.withContext, login-history, use-toast, react-router-dom (useSearchParams), platform
- Schema components: ArticleSchema/FAQSchema/BreadcrumbSchema use Helmet (mock react-helmet-async); RecipeSchema uses useEffect + DOM manipulation (test via document.getElementById)
- US-001 through US-006 already completed strict mode, dead code cleanup, env validation, error boundaries, route error boundaries, and API retry logic
- Build: `npx vite build` (the `npm run build` has an Expo prebuild step that requires native deps; Cloudflare Pages should use `npx vite build`)

---

## 2026-02-12 - US-007
- What was implemented: Health check API endpoint edge function
- Files changed:
  - `functions/health-check/index.ts` (new) - Edge function with DB connectivity check, timeout, version info
  - `supabase/config.toml` (modified) - Added `[functions.health-check]` with `verify_jwt = false`
- **Learnings for future iterations:**
  - Edge functions use Deno runtime, not Node.js - imports use URL-based modules
  - For DB connectivity checks, use `SUPABASE_SERVICE_ROLE_KEY` (falls back to `SUPABASE_ANON_KEY`) since health checks run without user auth
  - `Promise.race()` pattern works well for implementing timeouts on Supabase queries
  - The `kids` table is a safe lightweight table to query for connectivity checks
---

## 2026-02-23 - US-008: Calculate Food Similarity Edge Function
- What was implemented: Edge function that computes similarity scores between foods based on category, allergens, safety status, and name overlap
- Files changed:
  - `functions/calculate-food-similarity/index.ts` (new) - POST endpoint, JWT required, returns ranked similar foods with scores
- Accepts `food_id`, fetches source food and all user foods, calculates weighted similarity (category 40%, allergens 20%, safety 20%, name 20%)
---

## 2026-02-23 - US-009: Suggest Foods Edge Function
- What was implemented: Edge function that suggests safe foods for a child based on allergens, preferences, and food history
- Files changed:
  - `functions/suggest-foods/index.ts` (new) - POST endpoint, JWT required, returns scored food suggestions
- Merges allergens from kid profile and request, filters unsafe foods, prioritizes unused and favorite foods
---

## 2026-02-23 - US-010: Suggest Recipe Edge Function
- What was implemented: Edge function that ranks recipes by ingredient availability and filters by allergens
- Files changed:
  - `functions/suggest-recipe/index.ts` (new) - POST endpoint, JWT required, returns recipes with match percentages
- Accepts available_foods[], kid_ids[], dietary_restrictions[]; calculates match % and lists missing ingredients
---

## 2026-02-23 - US-011: AI Meal Plan Edge Function
- What was implemented: Edge function that generates weekly meal plans using algorithmic distribution (AI-ready when OPENAI_API_KEY configured)
- Files changed:
  - `functions/ai-meal-plan/index.ts` (new) - POST endpoint, JWT required, returns structured meal plan
- Accepts kid_ids[], date_range, dietary_restrictions; distributes safe foods across breakfast/lunch/dinner/snacks
---

## 2026-02-23 - US-012: Create Checkout Stripe Edge Function
- What was implemented: Edge function that creates Stripe checkout sessions for subscription purchases
- Files changed:
  - `functions/create-checkout/index.ts` (new) - POST endpoint, JWT required, returns checkout URL
- Uses Stripe REST API (no SDK needed in Deno), stores pending subscription in user_subscriptions table
---

## 2026-02-23 - US-013: Stripe Webhook Edge Function
- What was implemented: Edge function that processes Stripe webhook events with HMAC-SHA256 signature verification
- Files changed:
  - `functions/stripe-webhook/index.ts` (new) - POST endpoint, no JWT (uses webhook signature), handles 4 event types
- Handles: checkout.session.completed, customer.subscription.updated, customer.subscription.deleted, invoice.payment_failed
- Uses Web Crypto API for HMAC verification, 5-minute timestamp tolerance
---

## 2026-02-23 - US-014: Parse Recipe Edge Function
- What was implemented: Edge function that extracts recipe data from URLs via JSON-LD structured data with HTML fallback
- Files changed:
  - `functions/parse-recipe/index.ts` (new) - POST endpoint, no JWT, returns parsed recipe with ingredients/instructions/nutrition
- Tries JSON-LD Recipe schema first, falls back to Open Graph meta tags for basic info
---

## 2026-02-23 - US-015: Generate Blog Content Edge Function
- What was implemented: Edge function that generates blog content via OpenAI or template fallback
- Files changed:
  - `functions/generate-blog-content/index.ts` (new) - POST endpoint, no JWT, returns title/excerpt/body/meta_tags
- Uses gpt-4o-mini when OPENAI_API_KEY configured, otherwise generates structured template HTML
---

## 2026-02-23 - US-016: Generate Social Content Edge Function
- What was implemented: Edge function that generates platform-specific social media posts
- Files changed:
  - `functions/generate-social-content/index.ts` (new) - POST endpoint, no JWT, returns posts per platform
- Supports Twitter (280 char limit), Instagram (caption + hashtags), Facebook; AI or template generation
---

## 2026-02-23 - US-017: Update Blog Image Edge Function
- What was implemented: Edge function that fetches an image URL and uploads to Supabase Storage
- Files changed:
  - `functions/update-blog-image/index.ts` (new) - POST endpoint, no JWT, returns image URLs (original + size variants)
- Uploads to `blog-images` bucket, updates blog_posts table with featured_image URL
---

## 2026-02-23 - US-018: Login Rate Limiting
- What was implemented: Client-side sliding window rate limiter (5 attempts per 15 min window)
- Files changed:
  - `src/lib/rateLimiter.ts` (new) - checkRateLimit(), recordAttempt(), clearRateLimit(), formatRetryAfter()
  - `src/pages/Auth.tsx` (modified) - Integrated rate limiting into handleSignIn; shows remaining attempts and lockout timer
- Stores attempts in localStorage with timestamps; clears on successful login
---

## 2026-02-23 - US-019: Server-Side Rate Limiting Migration
- What was implemented: Database table and SQL function for server-side rate limit enforcement
- Files changed:
  - `supabase/migrations/20260223000000_rate_limiting.sql` (new) - rate_limits table with check_rate_limit() function
- RLS enabled (service role only), composite index on (identifier, action, window_start), auto-cleanup of old entries
---

## 2026-02-23 - US-020: CSP Headers Audit
- What was verified: The `public/_headers` file already has comprehensive security headers
- Already present: CSP, X-Frame-Options: DENY, X-Content-Type-Options: nosniff, HSTS (31536000 + preload), Referrer-Policy, Permissions-Policy
- No changes needed — all acceptance criteria already met
---

## 2026-02-23 - US-022: CSRF Protection
- What was implemented: Client-side CSRF token generation and validation module
- Files changed:
  - `src/lib/csrf.ts` (new) - getCsrfToken(), validateCsrfToken(), regenerateCsrfToken(), getCsrfHeaders()
- Uses Web Crypto API for random token generation, constant-time comparison, stored in sessionStorage
---

## 2026-02-23 - US-023: Protected Route Auth Flow
- What was verified: ProtectedRoute component already handles all acceptance criteria
- Already present: Route memory (saves redirect URL), loading state, session check, auth state listener
- No changes needed — redirects back to intended destination after login
---

## 2026-02-23 - US-031: Structured Logging
- What was implemented: Enhanced logger with structured JSON output, log levels, and request ID correlation
- Files changed:
  - `src/lib/logger.ts` (modified) - Added fatal level, structured JSON in production, human-readable in dev, request ID support
- Backward-compatible with existing callers (variadic args auto-parsed into context/error)
- Exports: logger, setRequestId(), generateRequestId()
---

## 2026-02-23 - US-033: Database Performance Indexes
- What was implemented: Composite indexes on frequently queried columns
- Files changed:
  - `supabase/migrations/20260223000001_performance_indexes.sql` (new) - 6 indexes using CREATE INDEX IF NOT EXISTS
- Indexes: plan_entries(kid_id, date), grocery_items(household_id, checked), foods(user_id, category), recipes(user_id, created_at), user_subscriptions(user_id, status), login_history(user_id, created_at)
---

## 2026-02-23 - US-035: Core Web Vitals Monitoring
- What was implemented: Web vitals tracking (LCP, FID, CLS, TTFB, INP) with Sentry reporting
- Files changed:
  - `src/lib/webVitals.ts` (new) - initWebVitals() tracks all 5 metrics, reports to Sentry, colored dev console output
  - `src/main.tsx` (modified) - Calls initWebVitals() after app renders
- Uses dynamic import of web-vitals for tree shaking, async Sentry reporting
---

## 2026-02-23 - US-032: Database Connection Configuration
- What was implemented: Enhanced Supabase client with realtime heartbeat, schema config, storage key, and client info header
- Files changed:
  - `src/integrations/supabase/client.ts` (modified) - Added heartbeat_interval_ms: 15_000, db schema: 'public', storageKey, X-Client-Info header
- Already had persistSession and autoRefreshToken; added connection stability improvements
---

## 2026-02-23 - US-036: Service Worker for Offline Caching
- What was verified: Service worker already exists in `public/sw.js` with proper caching strategies
- Already present: Cache-first for static assets, network-first for API calls, offline fallback page
- No changes needed — all acceptance criteria already met
---

## 2026-02-23 - US-037: User Data Export (GDPR Compliance)
- What was implemented: Enhanced data export in AccountSettings to include all user data tables
- Files changed:
  - `src/pages/dashboard/AccountSettings.tsx` (modified) - Export now fetches foods, recipes, plan_entries, grocery_items from Supabase
- Exports as JSON with schema_version, exported_at timestamp, and all major data categories
---

## 2026-02-23 - US-038: Account Deletion (GDPR Compliance)
- What was implemented: Enhanced account deletion with email confirmation and cascade deletion
- Files changed:
  - `src/pages/dashboard/AccountSettings.tsx` (modified) - Added email confirmation input, cascade deletes user data before account removal
- Deletes grocery_items, plan_entries, recipes, foods, kids in order, then signs out and redirects
---

## 2026-02-23 - US-040: GitHub Actions CI/CD Pipeline
- What was implemented: Full CI/CD workflow with quality, test, build, and deploy stages
- Files changed:
  - `.github/workflows/ci.yml` (new) - Multi-job pipeline: quality (lint+typecheck), test (vitest), build, deploy-production (main), deploy-staging (develop)
- Uses Cloudflare Pages deploy action, caches node_modules, runs on push/PR to main and develop
---

## 2026-02-23 - US-041: Staging Environment Configuration
- What was implemented: Staging environment variable file and Cloudflare wrangler config
- Files changed:
  - `.env.staging` (new) - Staging environment variable placeholders (VITE_SUPABASE_URL, etc.)
  - `wrangler.toml` (modified) - Added staging environment documentation and build:staging script reference
  - `package.json` (modified) - Added `build:staging` script
---

## 2026-02-23 - US-042: Migration Testing in CI
- What was implemented: Migration test job added to CI pipeline
- Files changed:
  - `.github/workflows/ci.yml` (modified) - Added migration-test job that validates SQL migrations parse correctly
- Checks migration file existence, validates SQL syntax patterns, ensures RLS and indexes are present
---

## 2026-02-23 - US-055: Loading Skeleton Components
- What was implemented: Skeleton layout components for major dashboard views
- Files changed:
  - `src/components/ui/skeleton-layouts.tsx` (new) - DashboardSkeleton, PlannerSkeleton, RecipesSkeleton, GrocerySkeleton
- Uses existing Skeleton UI component, responsive layouts matching actual page structures
---

## 2026-02-23 - US-061: Session Timeout Warning
- What was implemented: AlertDialog warning when session is about to expire
- Files changed:
  - `src/components/SessionTimeoutWarning.tsx` (new) - Checks JWT expiry every 60s, warns 5 min before, offers extend or sign out
- Uses supabase.auth.refreshSession() to extend, redirects to /auth on expiry with route memory
---

## 2026-02-23 - US-062: Offline Indicator
- What was implemented: Banner notification when user goes offline
- Files changed:
  - `src/components/OfflineIndicator.tsx` (new) - Shows offline banner with WifiOff icon, reconnecting state, pending mutation count
- Uses navigator.onLine and online/offline events, tracks pending mutations via localStorage queue

---

## Build Verification (Batch 2)
- `npx vite build`: SUCCESS (no errors)
- `npx tsc --noEmit`: SUCCESS (zero TypeScript errors)
- Large chunk warnings (vendor-misc 4.6MB) are pre-existing and tracked in US-034

## 2026-02-25 - US-024: Comprehensive Unit Tests for AppContext
- What was implemented: 32 unit tests for AppContext state management covering all CRUD operations
- Files changed:
  - `src/contexts/AppContext.test.tsx` (new) - Tests for foods, kids, recipes, planEntries, groceryItems CRUD, export/import/reset, activeKid management
- **Learnings for future iterations:**
  - AppContext operates in local-only mode (localStorage fallback) when Supabase auth session is null
  - Mock `@/integrations/supabase/client` and `@/lib/platform` getStorage to test local operations
  - Use `waitFor` to handle async initialization of starter data in useEffect
  - useApp throws when used outside AppProvider - test with try/catch
---

## 2026-02-25 - US-025: Unit Tests for Utility Modules
- What was implemented: 86 unit tests across 3 utility modules
- Files changed:
  - `src/lib/utils.test.ts` (new) - 21 tests: cn() class merging, generateId() uniqueness, debounce() timing, calculateAge() edge cases
  - `src/lib/platform.test.ts` (new) - 16 tests: isWeb/isMobile detection, getSyncStorage/getStorage/safeStorage operations, renderPlatform
  - `src/lib/seo-helpers.test.ts` (new) - 49 tests: all 12 exported functions including canonical URLs, OG images, meta validation, Twitter/OG tags, slugs, reading time, indexability, hreflang
- **Learnings for future iterations:**
  - isWeb() in jsdom returns a Document object (truthy but not strictly true) - use toBeTruthy() not toBe(true)
  - jest-dom doesn't have toEndWith matcher - use native string .endsWith()
  - vi.useFakeTimers() required for debounce tests, remember vi.useRealTimers() in afterEach
---

## 2026-02-25 - US-026: Unit Tests for Custom Hooks
- What was implemented: 15 unit tests across 3 custom hooks
- Files changed:
  - `src/hooks/useReducedMotion.test.ts` (new) - 4 tests: default false, matches true when set, responds to changes, cleans up listener
  - `src/hooks/useInView.test.ts` (new) - 5 tests: initial state, option handling (threshold, triggerOnce, rootMargin)
  - `src/hooks/useSubscription.test.ts` (new) - 6 tests: initial loading, null subscription, status helpers, action methods, actionLoading
- **Learnings for future iterations:**
  - useSubscription needs mocks for supabase, edge-functions, sonner, and react-router-dom
  - IntersectionObserver is globally mocked in test setup - useInView tests focus on ref/state
  - matchMedia mock in test setup defaults matches:false - override with vi.spyOn for reduced-motion tests
---

## 2026-02-25 - US-027: Unit Tests for Auth Components
- What was implemented: 6 unit tests for the Auth page component
- Files changed:
  - `src/pages/Auth.test.tsx` (new) - Tests rendering, form presence, tab triggers, inputs, labels, buttons
- **Learnings for future iterations:**
  - Auth page has deep dependency tree: Supabase, router, toast, Helmet, rateLimiter, conversion-tracking, logger, login-history, use-toast, platform
  - logger.withContext() must be mocked (returns sub-logger object) - login-history.ts uses it at class init time
  - Auth renders OnboardingDialog which uses useApp() - must wrap in AppProvider
  - useSearchParams must be in react-router-dom mock (returns [URLSearchParams, setter])
---

## 2026-02-25 - US-028: Unit Tests for Admin Dashboard Components
- What was implemented: 8 unit tests for 4 admin components
- Files changed:
  - `src/components/admin/AlertManager.test.tsx` (new) - 2 tests: renders, container check
  - `src/components/admin/FeatureFlagDashboard.test.tsx` (new) - 2 tests: renders, container check
  - `src/components/admin/LiveActivityFeed.test.tsx` (new) - 2 tests: renders, container check
  - `src/components/admin/SystemHealthDashboard.test.tsx` (new) - 2 tests: renders, container check
- **Learnings for future iterations:**
  - Admin components need full Supabase mock chain: from().select().order().limit()
  - Some admin components use real-time subscriptions - mock channel().on().subscribe()
  - Use container.firstChild for DOM presence checks instead of attribute selectors
---

## 2026-02-25 - US-029: Unit Tests for SEO Schema Components
- What was implemented: 45 unit tests for 4 schema components + helpers
- Files changed:
  - `src/components/schema/ArticleSchema.test.tsx` (new) - 8 tests: JSON-LD graph structure, Article/BreadcrumbList/WebPage types, defaults, custom author, keywords
  - `src/components/schema/FAQSchema.test.tsx` (new) - 6 tests: FAQPage type, Question/Answer structure, empty array handling
  - `src/components/schema/RecipeSchema.test.tsx` (new) - 11 tests: script tag creation, Recipe type, ingredients, HowToStep, nutrition, rating, cleanup on unmount
  - `src/components/schema/BreadcrumbSchema.test.tsx` (new) - 6 tests: BreadcrumbList type, ListItem positions, names/URLs, single item
  - RecipeSchema helpers: formatRecipeTime (4 tests), validateRecipeSchema (10 tests)
- **Learnings for future iterations:**
  - ArticleSchema/FAQSchema/BreadcrumbSchema use Helmet - mock react-helmet-async to capture JSON-LD from children
  - RecipeSchema uses useEffect + direct DOM manipulation (createElement/appendChild) - test via document.getElementById('recipe-schema')
  - RecipeSchema cleans up script on unmount - verify with unmount() then check element removed
  - formatRecipeTime: when minutes=0 and hours>0, returns 'PT1H' not 'PT1H0M' (code: `mins > 0 || hours === 0`)
---

## 2026-02-25 - US-030: Configure Vitest Coverage Thresholds
- What was implemented: Updated coverage configuration with proper thresholds and exclusion patterns
- Files changed:
  - `vitest.config.ts` (modified) - Set branches threshold to 65%, added exclusions for generated types and test files
- Thresholds: lines 70%, functions 70%, branches 65%, statements 70%
- Exclusions added: `src/integrations/supabase/types.ts`, `**/*.test.{ts,tsx}`, `**/*.spec.{ts,tsx}`
---

## Build Verification (Batch 3)
- `npx vite build`: SUCCESS (no errors)
- `npx tsc --noEmit`: SUCCESS (zero TypeScript errors)
- `npx vitest run`: SUCCESS (382 tests passing, 2 skipped)
- Test count increased from 176 to 382 (+206 new tests)

---

## 2026-02-26 - US-034: Optimize Bundle Splitting for Vendor Chunks
- What was implemented: Split Three.js and Swagger UI into separate vendor chunks
- Files changed:
  - `vite.config.ts` (modified) - Added vendor-three-core, vendor-three-eco, vendor-swagger, vendor-swagger-deps manual chunks
- Key decisions:
  - Three.js core (653KB) and swagger-ui (1023KB) are inherently monolithic and cannot be split further
  - Both are lazy-loaded, so they don't affect initial page load
  - Kept DOMPurify out of swagger-deps since it's shared across blog/admin components
- All other 15 vendor chunks under 500KB

---

## 2026-02-26 - US-043: Mobile Touch Target Accessibility Fixes
- What was implemented: Ensured all interactive elements meet 44x44px minimum touch targets
- Files changed:
  - `src/components/ui/button.tsx` - Button sm variant h-10 → h-11 (44px)
  - `src/components/ui/toggle.tsx` - Toggle default/sm h-10/h-9 → h-11 (44px)
  - `src/components/GestureTutorial.tsx` - Close button min-h-11 + aria-label, progress dots wrapped in h-11 container
  - `src/components/NotificationBell.tsx` - Dismiss button h-6 → h-11 (44px) + aria-label
- Global mobile-first.css already enforces min-height:44px on all button elements

---

## 2026-02-26 - US-044: Fix Color Contrast Ratios for WCAG 2.1 AA
- What was implemented: Replaced hardcoded hex colors with CSS custom properties for dark mode compat
- Files changed:
  - `src/styles/mobile-first.css` - Replaced #1f2937/#6b7280/#111827 with hsl(var(--foreground))/hsl(var(--muted-foreground)); replaced @media (prefers-color-scheme: dark) with .dark class selector
- Key learning: App uses darkMode: ["class"], not media queries. Hardcoded hex colors broke class-based dark mode.
- Muted-foreground contrast: light mode ~6.1:1 (passes AA), dark mode ~9:1 (exceeds AA)

---

## 2026-02-26 - US-045: Add Keyboard Navigation Support
- What was implemented: Added id="main-content" to 11 more pages for skip-to-content link
- Files changed:
  - BlogPost, Authors, BudgetCalculatorResults, MealPlanGeneratorResults, PickyEaterQuizResults, ResetPassword, ApiDocs, FoodChaining, SEODashboard, SearchTrafficDashboard, CheckoutSuccess
- Total 28 pages now have skip link targets (up from 17)
- Existing infrastructure: SkipToContent in App.tsx, useFocusTrap hook, RouteAnnouncer, Radix UI keyboard support

---

## 2026-02-26 - US-046: Add ARIA Live Regions for Dynamic Content
- What was implemented: Added aria-busy/role="status" to Blog and Authors loading states
- Files changed:
  - `src/pages/Blog.tsx` - aria-busy={isLoading} on main, role="status" on loading div
  - `src/pages/Authors.tsx` - role="status" + aria-busy on loading skeleton
- Existing infrastructure already covers all criteria:
  - Sonner: aria-live="polite" on section wrapper
  - Radix Toast: aria-live="assertive"/"polite" based on type
  - AccessibleFormField: aria-live="assertive" for errors
  - AccessibleLoading: aria-busy="true" for loading states
  - RouteAnnouncer: aria-live="polite" for navigation
  - useAnnounce hook: dynamic screen reader announcements

---

## Build Verification (Batch 4)
- `npx vite build`: SUCCESS
- `npx tsc --noEmit`: SUCCESS (zero TypeScript errors)
- `npx vitest run`: SUCCESS (382 tests passing, 2 skipped)
- Stories completed this batch: US-034, US-043, US-044, US-045, US-046
- Total stories complete: 54 of 110 (passes: true)
- Remaining: 56 stories with passes: false

---

## 2026-02-26 - US-052: Add Real-Time Admin Activity Feed
- What was implemented: LiveActivityFeed component already fully implemented; enhanced test suite from 2 to 9 tests
- Files changed:
  - `src/components/admin/LiveActivityFeed.test.tsx` (rewritten) - 9 tests covering: heading/Live badge, activity items, anonymized users, timestamps, severity badges, stats footer, filter/search, real-time subscription, table fetch
- Component already had: real-time Supabase subscription on admin_live_activity, anonymized user IDs, action type filter dropdown, 100-event limit with auto-scroll, severity-based styling, CSV export, polling fallback
- **Learnings for future iterations:**
  - vi.mock factory is hoisted — cannot reference top-level `const` variables from the test file; inline data directly in the mock factory
  - LiveActivityFeed imports from `@/hooks/use-toast` (not `sonner`) — mock the correct module
  - The component gracefully handles missing table (42P01 error) — shows warning card instead of crashing
---
