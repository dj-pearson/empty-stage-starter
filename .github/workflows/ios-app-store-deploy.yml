name: iOS App Store Deploy

# Manual trigger with version input
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'App version (e.g., 1.2.0)'
        required: true
        type: string
      build_number:
        description: 'Build number (auto-increments if empty)'
        required: false
        type: string
        default: ''
      release_notes:
        description: 'What changed in this release'
        required: false
        type: string
        default: 'Bug fixes and performance improvements.'
      submit_for_review:
        description: 'Submit to App Store Review after upload'
        required: false
        type: boolean
        default: false

# Prevent concurrent deployments
concurrency:
  group: ios-deploy
  cancel-in-progress: false

env:
  XCODE_VERSION: '15.4'
  SCHEME: 'EatPal'
  PROJECT_DIR: 'ios/EatPal'
  BUNDLE_ID: 'com.eatpal.app'

jobs:
  # -------------------------------------------------------------------
  # Job 1: Validate inputs and compute build number
  # -------------------------------------------------------------------
  validate:
    name: Validate & Prepare
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}
    steps:
      - name: Validate version format
        id: version
        run: |
          VERSION="${{ inputs.version }}"
          # Validate semver format
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "::error::Version must be in semver format (e.g., 1.2.0). Got: $VERSION"
            exit 1
          fi

          # Compute build number
          BUILD="${{ inputs.build_number }}"
          if [ -z "$BUILD" ]; then
            # Auto-generate from date + run number
            BUILD="$(date -u +%Y%m%d).${{ github.run_number }}"
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "build_number=$BUILD" >> "$GITHUB_OUTPUT"
          echo "## Build Info" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Version**: $VERSION" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Build**: $BUILD" >> "$GITHUB_STEP_SUMMARY"

  # -------------------------------------------------------------------
  # Job 2: Build, sign, and upload to App Store Connect
  # -------------------------------------------------------------------
  build-and-deploy:
    name: Build & Deploy to App Store
    needs: validate
    runs-on: macos-14
    timeout-minutes: 60
    env:
      APP_VERSION: ${{ needs.validate.outputs.version }}
      BUILD_NUMBER: ${{ needs.validate.outputs.build_number }}
    steps:
      # ---------------------------------------------------------------
      # Checkout & Setup
      # ---------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Show Xcode version
        run: xcodebuild -version

      # ---------------------------------------------------------------
      # Update version in project files
      # ---------------------------------------------------------------
      - name: Update version and build number
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "Setting version to $APP_VERSION (build $BUILD_NUMBER)"

          # Update Info.plist
          PLIST_PATH="EatPal/Resources/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $APP_VERSION" "$PLIST_PATH"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" "$PLIST_PATH"

          echo "Updated Info.plist:"
          /usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "$PLIST_PATH"
          /usr/libexec/PlistBuddy -c "Print :CFBundleVersion" "$PLIST_PATH"

      # ---------------------------------------------------------------
      # Install certificates & provisioning profiles
      # ---------------------------------------------------------------
      - name: Install Apple certificate
        env:
          P12_CERTIFICATE_BASE64: ${{ secrets.IOS_P12_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        run: |
          # Create a temporary keychain
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Decode and import certificate
          CERTIFICATE_PATH="$RUNNER_TEMP/certificate.p12"
          echo -n "$P12_CERTIFICATE_BASE64" | base64 --decode -o "$CERTIFICATE_PATH"
          security import "$CERTIFICATE_PATH" \
            -P "$P12_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          # Set keychain search list
          security list-keychain -d user -s "$KEYCHAIN_PATH"

      - name: Install provisioning profile
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          PROFILE_PATH="$RUNNER_TEMP/profile.mobileprovision"
          echo -n "$PROVISIONING_PROFILE_BASE64" | base64 --decode -o "$PROFILE_PATH"

          # Install to standard location
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c "Print :UUID" /dev/stdin <<< \
            $(security cms -D -i "$PROFILE_PATH"))
          cp "$PROFILE_PATH" \
            ~/Library/MobileDevice/Provisioning\ Profiles/"$PROFILE_UUID.mobileprovision"

          echo "Installed profile: $PROFILE_UUID"

      # ---------------------------------------------------------------
      # Resolve dependencies (with caching)
      # ---------------------------------------------------------------
      - name: Cache SPM dependencies
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}/spm-cache
          key: spm-deploy-${{ runner.os }}-${{ hashFiles('ios/EatPal/Package.swift') }}
          restore-keys: |
            spm-deploy-${{ runner.os }}-

      - name: Resolve Swift Package Manager dependencies
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          xcodebuild -resolvePackageDependencies \
            -scheme "$SCHEME" \
            -clonedSourcePackagesDirPath "$RUNNER_TEMP/spm-cache"

      # ---------------------------------------------------------------
      # Build archive
      # ---------------------------------------------------------------
      - name: Build archive
        working-directory: ${{ env.PROJECT_DIR }}
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          ARCHIVE_PATH="$RUNNER_TEMP/EatPal.xcarchive"

          xcodebuild archive \
            -scheme "$SCHEME" \
            -sdk iphoneos \
            -configuration Release \
            -archivePath "$ARCHIVE_PATH" \
            -clonedSourcePackagesDirPath "$RUNNER_TEMP/spm-cache" \
            -destination "generic/platform=iOS" \
            MARKETING_VERSION="$APP_VERSION" \
            CURRENT_PROJECT_VERSION="$BUILD_NUMBER" \
            PRODUCT_BUNDLE_IDENTIFIER="${{ env.BUNDLE_ID }}" \
            SUPABASE_URL="$SUPABASE_URL" \
            SUPABASE_ANON_KEY="$SUPABASE_ANON_KEY" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            | xcpretty --color

          echo "Archive created at: $ARCHIVE_PATH"
          ls -la "$ARCHIVE_PATH"

      # ---------------------------------------------------------------
      # Export IPA
      # ---------------------------------------------------------------
      - name: Create export options plist
        run: |
          cat > "$RUNNER_TEMP/ExportOptions.plist" << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store-connect</string>
              <key>destination</key>
              <string>upload</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
              <key>provisioningProfiles</key>
              <dict>
                  <key>com.eatpal.app</key>
                  <string>EatPal App Store</string>
              </dict>
          </dict>
          </plist>
          PLIST

      - name: Export IPA
        run: |
          ARCHIVE_PATH="$RUNNER_TEMP/EatPal.xcarchive"
          EXPORT_PATH="$RUNNER_TEMP/export"

          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportOptionsPlist "$RUNNER_TEMP/ExportOptions.plist" \
            -exportPath "$EXPORT_PATH" \
            | xcpretty --color

          echo "Exported IPA:"
          ls -la "$EXPORT_PATH"/*.ipa

      # ---------------------------------------------------------------
      # Upload to App Store Connect
      # ---------------------------------------------------------------
      - name: Upload to App Store Connect
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
        run: |
          # Write API key to file
          API_KEY_PATH="$RUNNER_TEMP/AuthKey.p8"
          echo -n "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode -o "$API_KEY_PATH"

          EXPORT_PATH="$RUNNER_TEMP/export"
          IPA_PATH=$(find "$EXPORT_PATH" -name "*.ipa" -type f | head -1)

          echo "Uploading $IPA_PATH to App Store Connect..."

          # Set up API key directory for xcrun
          mkdir -p ~/.appstoreconnect/private_keys
          cp "$API_KEY_PATH" ~/.appstoreconnect/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8

          xcrun altool --upload-app \
            --type ios \
            --file "$IPA_PATH" \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_ISSUER_ID" \
            2>&1

          echo "Upload complete!"

      # ---------------------------------------------------------------
      # (Optional) Submit for review
      # ---------------------------------------------------------------
      - name: Submit for App Store Review
        if: ${{ inputs.submit_for_review }}
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
        run: |
          echo "Submitting version $APP_VERSION for App Store review..."
          echo "Note: The build must finish processing on App Store Connect before review submission."
          echo "This may take 15-30 minutes after upload."
          echo ""
          echo "To manually submit: Go to App Store Connect > My Apps > EatPal > Submit for Review"

      # ---------------------------------------------------------------
      # Cleanup
      # ---------------------------------------------------------------
      - name: Cleanup keychain
        if: always()
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH"
          fi
          rm -f "$RUNNER_TEMP/certificate.p12"
          rm -f "$RUNNER_TEMP/profile.mobileprovision"
          rm -f "$RUNNER_TEMP/AuthKey.p8"

      # ---------------------------------------------------------------
      # Summary
      # ---------------------------------------------------------------
      - name: Build summary
        if: success()
        run: |
          echo "## iOS App Store Deploy - Success" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Field | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Version** | $APP_VERSION |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Build** | $BUILD_NUMBER |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Bundle ID** | ${{ env.BUNDLE_ID }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Submit for Review** | ${{ inputs.submit_for_review }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Release Notes** | ${{ inputs.release_notes }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "The build has been uploaded to App Store Connect." >> "$GITHUB_STEP_SUMMARY"
          echo "It will appear in TestFlight after processing (15-30 min)." >> "$GITHUB_STEP_SUMMARY"

  # -------------------------------------------------------------------
  # Job 3: Tag the release in git
  # -------------------------------------------------------------------
  tag-release:
    name: Tag Release
    needs: [validate, build-and-deploy]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      APP_VERSION: ${{ needs.validate.outputs.version }}
      BUILD_NUMBER: ${{ needs.validate.outputs.build_number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create git tag
        run: |
          TAG="ios/v${APP_VERSION}+${BUILD_NUMBER}"
          git tag -a "$TAG" -m "iOS v${APP_VERSION} (build ${BUILD_NUMBER})"
          git push origin "$TAG"
          echo "Tagged release: $TAG" >> "$GITHUB_STEP_SUMMARY"
