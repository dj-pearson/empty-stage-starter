import Foundation

/// Generates grocery list items from meal plan entries and recipes.
enum GroceryGeneratorService {
    /// Generates grocery items from a week's meal plan entries.
    /// Cross-references recipes to extract ingredients, and deduplicates.
    @MainActor
    static func generateFromMealPlan(
        weekStart: Date,
        kidIds: [String],
        appState: AppState
    ) async throws -> [GroceryItem] {
        let calendar = Calendar.current
        let dates = (0..<7).map { offset in
            calendar.date(byAdding: .day, value: offset, to: weekStart)!
        }

        // Collect all food IDs from plan entries for the week
        var foodIdCounts: [String: Int] = [:]
        for date in dates {
            for kidId in kidIds {
                let entries = appState.planEntriesForDate(date, kidId: kidId)
                for entry in entries {
                    foodIdCounts[entry.foodId, default: 0] += 1
                }
            }
        }

        // Build grocery items from foods, deduplicating
        var groceryItems: [GroceryItem] = []
        let existingNames = Set(appState.groceryItems.map { $0.name.lowercased() })

        for (foodId, count) in foodIdCounts {
            guard let food = appState.foods.first(where: { $0.id == foodId }) else { continue }

            // Skip if already on grocery list
            if existingNames.contains(food.name.lowercased()) { continue }

            let item = GroceryItem(
                id: UUID().uuidString,
                userId: "",
                name: food.name,
                category: food.category,
                quantity: Double(count),
                unit: food.unit ?? "servings",
                checked: false,
                aisle: food.aisle,
                autoGenerated: true
            )

            groceryItems.append(item)
        }

        // Also check recipes for additional ingredients
        let recipeIds = Set(appState.planEntries.compactMap(\.recipeId))
        for recipe in appState.recipes where recipeIds.contains(recipe.id) {
            if let ingredients = recipe.additionalIngredients {
                for ingredient in ingredients {
                    let ingredientLower = ingredient.lowercased()
                    if !existingNames.contains(ingredientLower) &&
                       !groceryItems.contains(where: { $0.name.lowercased() == ingredientLower }) {
                        groceryItems.append(GroceryItem(
                            id: UUID().uuidString,
                            userId: "",
                            name: ingredient,
                            category: "other",
                            quantity: 1,
                            unit: "",
                            checked: false,
                            autoGenerated: true
                        ))
                    }
                }
            }
        }

        return groceryItems.sorted { $0.category < $1.category }
    }

    /// Adds all generated items to the grocery list via AppState.
    @MainActor
    static func addGeneratedItems(
        _ items: [GroceryItem],
        appState: AppState
    ) async throws {
        for item in items {
            try await appState.addGroceryItem(item)
        }

        let toast = ToastManager.shared
        toast.success("Grocery list updated", message: "Added \(items.count) items from meal plan.")
        HapticManager.success()
    }
}
