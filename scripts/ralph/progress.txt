## Codebase Patterns
- TypeScript strict mode is enabled in both `tsconfig.json` and `tsconfig.app.json` - all new code must be strict-compliant
- AppContext.tsx uses `RecipeRow` (DB type) and `RecipeInsert` for typed Supabase operations - use `Database['public']['Tables'][tableName]['Row']` pattern for other tables
- Real-time subscription callbacks should use `RealtimePayload<T>` interface defined in AppContext.tsx for type safety
- DB uses snake_case, UI uses camelCase - `normalizeRecipeFromDB()` maps between them
- `npx tsc --noEmit` for typecheck, `npx vitest run` for tests (176 passing), `npm run build` for full build (~3.5 min)
- Explicit `any` types exist in ~82 files (mostly admin/integration code) - these pass `noImplicitAny` but should be replaced with proper types incrementally
- Error boundaries: `ErrorBoundary` (component-level, card UI) and `ErrorBoundary fullPage` (top-level, full-page UI) in `src/components/ErrorBoundary.tsx`; `RouteErrorBoundary` (per-route) in `src/components/RouteErrorBoundary.tsx`. All report to Sentry via `logError()`.
- Use `logError(error, context)` from `src/lib/sentry.tsx` for Sentry reporting - it's safe to call regardless of Sentry configuration
- Use `withRetry()` from `src/lib/apiRetry.ts` for generic async retry, `withSupabaseRetry()` for Supabase queries that return `{ data, error }` - only retries network/5xx errors

# Ralph Progress Log
Started: Thu Feb 12 10:21:37 CST 2026
---

## 2026-02-12 - US-001
- Enabled `strict: true` in tsconfig.app.json (was `false`) and tsconfig.json
- Removed redundant `noImplicitAny: true` from tsconfig.app.json (covered by strict)
- Replaced `any` types in AppContext.tsx with proper typed alternatives:
  - `normalizeRecipeFromDB(r: any)` → `normalizeRecipeFromDB(r: RecipeRow)`
  - `dbPayload: any` → `dbPayload: Partial<RecipeInsert>`
  - Removed `(recipeData as any).field` casts in recipe migration code
  - Real-time subscription callbacks: `(payload: any)` → `RealtimePayload<GroceryItem|PlanEntry|Kid>`
  - `dbUpdates: any` → `dbUpdates: Partial<RecipeRow>`
- Added `Database` type import, `RecipeRow`, `RecipeInsert` type aliases, and `RealtimePayload<T>` interface
- Files changed: tsconfig.json, tsconfig.app.json, src/contexts/AppContext.tsx, prd.json
- **Learnings for future iterations:**
  - The codebase was already `noImplicitAny: true` compliant, so enabling strict mode caused zero new errors
  - `strict: true` subsumes `noImplicitAny`, `strictNullChecks`, `strictFunctionTypes`, etc.
  - ~82 files still have explicit `any` types (pass noImplicitAny) - these are mostly in admin/integration components
  - Supabase DB types are at `src/integrations/supabase/types.ts` with `Database['public']['Tables'][name]['Row'|'Insert'|'Update']` pattern
---

## 2026-02-12 - US-002
- Deleted `src/components/admin/BlogCMSManager-OLD.tsx.bak` and `src/components/admin/EmailMarketingManager-OLD.tsx.bak`
- Removed unused imports across 52 admin component files (already present as unstaged changes)
- Prefixed unused variables with `_` for linter compliance (e.g., `isCollapsed` → `_isCollapsed` in AdminSidebar.tsx)
- Searched for `.bak`, `.backup`, `.old`, `.orig` files - no additional tracked files found
- Files changed: 54 admin component files (52 modified, 2 deleted)
- **Learnings for future iterations:**
  - The unused import removals were already present as unstaged working tree changes when this iteration started
  - The `backup/` directory contains DB backup files but is not tracked in git
  - Pre-existing test timing issue in `useScanner.test.ts` causes 1 error after test run but all 176 tests pass
  - ESLint `--quiet` shows many `@typescript-eslint/no-explicit-any` and `@ts-nocheck` errors in admin components - these are pre-existing and out of scope for this story
---

## 2026-02-12 - US-003
- Created `src/lib/env.ts` with Zod schema validating all VITE_ environment variables
- Required vars: `VITE_SUPABASE_URL` (validated as URL), `VITE_SUPABASE_ANON_KEY` (non-empty string)
- Optional vars with correct types: `VITE_SENTRY_DSN` (URL or empty), `VITE_SENTRY_ENABLED` (enum "true"/"false" → boolean), `VITE_STRIPE_PUBLISHABLE_KEY`, `VITE_GA_MEASUREMENT_ID`, `VITE_FUNCTIONS_URL` (URL or empty)
- Exports typed `Env` type and `getEnv()` accessor
- `validateEnv()` called in `src/main.tsx` before Sentry initialization and app render
- In dev mode, logs clear error messages listing each missing/invalid var
- In production, returns null silently (app already handles missing config via mock Supabase client)
- Files changed: src/lib/env.ts (new), src/main.tsx
- **Learnings for future iterations:**
  - The Supabase client already handles missing env vars gracefully with a mock client pattern - env validation supplements but doesn't replace this
  - `import.meta.env.VITE_*` values are `string | undefined` at runtime - Zod `.optional()` handles the undefined case
  - VITE_SENTRY_DSN and VITE_FUNCTIONS_URL can be empty strings in .env files, so validation must allow both URL and empty string
---

## 2026-02-12 - US-004
- Enhanced `src/components/ErrorBoundary.tsx` with:
  - `fullPage` prop for top-level app wrapping (renders full-page error UI)
  - Sentry error reporting via `logError()` with component stack trace context
  - `errorInfo` state to capture and display React component stack in dev mode
  - Dev mode: shows error message, stack trace, and component stack
  - Production mode: shows friendly message ("Our team has been notified...")
  - "Try Again" button resets error state, "Go Home" button navigates to /
- Updated `src/main.tsx`:
  - Replaced conditional `SentryErrorBoundary` (only when DSN configured) with our `ErrorBoundary fullPage` (always wraps App)
  - Removed `@sentry/react` ErrorBoundary and sentry ErrorFallback imports
  - ErrorBoundary now handles Sentry reporting internally via `logError()`
- Files changed: src/components/ErrorBoundary.tsx, src/main.tsx, prd.json
- **Learnings for future iterations:**
  - `logError()` from `src/lib/sentry.tsx` handles Sentry reporting conditionally (only in prod or when VITE_SENTRY_ENABLED=true) - safe to call always
  - The sentry.tsx `ErrorFallback` is now unused by main.tsx but still exported for potential other uses
  - React class error boundaries need `getDerivedStateFromError` for synchronous state updates and `componentDidCatch` for side effects (logging/Sentry)
  - The try/catch block in main.tsx around `createRoot().render()` catches pre-React errors (e.g., missing root element); ErrorBoundary catches errors during React rendering
---

## 2026-02-12 - US-006
- Created `src/lib/apiRetry.ts` with two main exports:
  - `withRetry<T>(operation, config?)` - generic retry wrapper for any async operation
  - `withSupabaseRetry<T>(operation, config?)` - Supabase-specific wrapper that handles `{ data, error }` return pattern
- Exponential backoff: 1s → 2s → 4s (configurable via `initialDelayMs`, `backoffMultiplier`, `maxDelayMs`)
- Only retries network errors and 5xx server errors; 4xx client errors are NOT retried
- `AbortSignal` support via `config.signal` for cancellation; throws `RetryAbortedError` on abort
- `isRetryableError()` exported for external use to check if an error should be retried
- Dev-mode console warnings for each retry attempt
- Files changed: src/lib/apiRetry.ts (new), prd.json, scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - Supabase client methods return `{ data, error }` instead of throwing - need a wrapper (`withSupabaseRetry`) that throws retryable errors so the retry loop can catch them
  - `import.meta.env.DEV` is available in library modules for conditional dev logging
  - Network errors from `fetch` manifest as `TypeError: Failed to fetch` - check for this pattern
  - DOMException with name `AbortError` indicates user-initiated abort and should NOT be retried
---

## 2026-02-28 - Ralph Loop Batch: US-017, US-021, US-022, US-024, US-027, US-033, US-038, US-041, US-042, US-043, US-044, US-047

### US-017: Switch build minifier from Terser to esbuild
- Changed `minify: 'terser'` to `minify: 'esbuild'` in vite.config.ts
- Replaced `terserOptions.compress.drop_console` with `esbuild.drop: ['console', 'debugger']`
- Added `sourcemap: 'hidden'` for production (Sentry sourcemap uploads)
- Build time improved from ~3.5min to ~55s
- Files changed: vite.config.ts

### US-021: Fix dead links to /notifications and /help
- NotificationBell.tsx: Changed `/notifications` → `/dashboard` (route doesn't exist)
- SupportWidget.tsx: Changed `/help` → `/faq` (verified /faq route exists in App.tsx)
- Files changed: src/components/subscription/NotificationBell.tsx, src/components/SupportWidget.tsx

### US-022: Fix hardcoded colors breaking dark mode
- SuccessAnimations.tsx: `bg-white` → `bg-card`, `text-gray-900` → `text-foreground`, `text-gray-600` → `text-muted-foreground`
- ProductShowcase3D.tsx: `bg-white` → `bg-card`, `bg-gray-100` → `bg-muted`, `text-gray-400` → `text-muted-foreground/70`, `text-gray-600` → `text-muted-foreground`, `to-white` → `to-background`
- HarmonizedFoodDisplay.tsx: `text-gray-600/700/500` → `text-muted-foreground`
- MealSuggestionCard.tsx: `bg-gray-100 text-gray-700` → `bg-muted text-muted-foreground`, `bg-white/90 text-black` → `bg-background/90 text-foreground`
- form-field.tsx: `text-red-500` → `text-destructive`, `border-red-500` → `border-destructive`
- Files changed: 5 component files

### US-024: Add DialogDescription for accessibility
- Added `<DialogDescription className="sr-only">` to RecipeViewWithScaling.tsx (both conditional branches)
- Verified 7 other listed files already had DialogDescription
- Files changed: src/components/RecipeViewWithScaling.tsx

### US-027: Add autoFocus to dialog form inputs
- Added autoFocus to primary input in 8 dialog forms:
  - AddFoodDialog (name Input), CreateGroceryListDialog (name Input), ManageKidsDialog (name Input)
  - CreateCollectionDialog (name Input), BulkAddFoodDialog (Textarea), ImportRecipeDialog (URL Input)
  - SaveMealPlanTemplateDialog (name Input), CreateStoreLayoutDialog (name Input)
- Files changed: 8 dialog components

### US-033: Fix permanent will-change CSS property
- Removed `will-change: transform, box-shadow` from `.gsap-meal-item` base rule
- Added `will-change` only on `:hover` and `:active` states
- Added `@media (prefers-reduced-motion: reduce)` rule to disable `animate-bounce-dynamic`
- Files changed: src/index.css

### US-038: Add loading states to dialog submit buttons
- AddFoodDialog: Added `isSaving` state, made handleSave async, added Loader2 spinner to save button
- ManageKidsDialog: Added `isSubmitting` state, made handleSubmit async, added Loader2 spinner + disabled state
- Files changed: src/components/AddFoodDialog.tsx, src/components/ManageKidsDialog.tsx

### US-041: Fix interactive div elements to semantic HTML
- Added `role="button"`, `tabIndex={0}`, and `onKeyDown` (Enter/Space) to 3 onboarding step divs in Home.tsx
- Added same keyboard support to 2 Quick Action Card elements in Home.tsx
- Fixed overlay div in GestureTutorial.tsx with button role and keyboard support
- Files changed: src/pages/Home.tsx, src/components/GestureTutorial.tsx

### US-042: Fix heading hierarchy on dashboard Home page
- Added `<h1 className="sr-only">EatPal Dashboard</h1>` as visually hidden page heading
- Changed 5 `<h4>` section headings to `<h2>` with `text-base` class for visual consistency
- Files changed: src/pages/Home.tsx

### US-043: Fix GSAP animations to respect prefers-reduced-motion
- Added `window.matchMedia('(prefers-reduced-motion: reduce)')` check before GSAP initialization in Landing.tsx
- Early return skips all ScrollTrigger animations when reduced motion is preferred
- CSS `animate-bounce-dynamic` also respects reduced-motion (done in US-033)
- Files changed: src/pages/Landing.tsx

### US-044: Fix Pricing page accessibility
- Removed contradictory `aria-hidden="true"` from `sr-only` entity marker div
- Changed `aria-pressed` to `aria-checked` on billing toggle buttons
- Added `role="radio"` to billing toggle buttons (matching parent `role="radiogroup"`)
- Files changed: src/pages/Pricing.tsx

### US-047: Fix RecipeListItem image alt text
- Changed `alt=""` to `alt={recipe.name}` on recipe thumbnail images
- Files changed: src/components/recipes/RecipeListItem.tsx

### Build Verification
- `npm run build` succeeds in ~55s (esbuild minifier)
- No TypeScript errors

### Progress Summary
- 12 stories completed this session (US-017, US-021, US-022, US-024, US-027, US-033, US-038, US-041, US-042, US-043, US-044, US-047)
- Total: 21/50 stories now passing
- Remaining: 29 stories with passes: false
---

## 2026-02-28 - Ralph Loop Batch 3: Platform Hardening & UI/UX (29 stories)

### US-007: Fix overly permissive RLS INSERT policies
- Created `supabase/migrations/20260228000000_fix_rls_policies.sql`
- Fixed login_history INSERT/UPDATE to require auth.uid() = user_id
- Fixed security_audit_logs INSERT to require auth.uid() IS NOT NULL
- Fixed rate_limits: service role only (no user policies)
- Fixed automation_email_queue: admin role only
- Fixed backup_logs: admin role only
- Fixed blog_comments INSERT: require auth.uid() IS NOT NULL
- Files changed: supabase/migrations/20260228000000_fix_rls_policies.sql (new)

### US-015: Remove unused dependencies
- Removed `jsonwebtoken` and `@modelcontextprotocol/sdk` from package.json (64 packages removed)
- Neither was imported anywhere in src/
- Files changed: package.json, package-lock.json

### US-016: Remove unoptimized PNG files and fix preloads
- Removed splash.png (1.9MB), Cover.png (1.9MB), Palette.png (1.3MB), Icon-Large.png (892KB), favicon_io.zip (330KB) — total 6.3MB removed
- WebP versions exist for all (64KB-65KB each)
- Updated all Cover.png references to Cover.webp in: SEOHead.tsx, BlogPost.tsx, BlogPostTemplate.tsx, SoftwareAppSchema.tsx, SEOManager.tsx, BlogCMSManager.tsx
- Fixed public/_headers: removed stale inter-var.woff2 font preload, changed Logo-Green.png preload to Logo-Green.webp
- Files changed: 6 source files, public/_headers, 5 files removed

### US-019: Replace window.confirm() with AlertDialog
- Replaced window.confirm() in 10 components with shadcn AlertDialog
- Components: AIMealCoach, FeatureFlagDashboard, NutritionManager, PromotionalCampaignManager, PromptTemplateManager, ComplementarySubscriptionManager, UserRolesManager, ProfessionalSettings, Billing, SubscriptionOverview
- All use destructive variant styling for delete/cancel actions

### US-020: Add confirmation dialogs to unprotected delete actions
- Added AlertDialog confirmations to: PantryListItem, EnhancedRecipeCard, AISettingsManager
- Each shows item name in title/description before deletion

### US-023: Fix touch target sizes below 44px minimum
- PantryListItem: quantity stepper h-6→h-10, edit/delete h-7→h-10
- AddFoodDialog: quantity presets h-7→h-10
- ManageStoreAislesDialog: delete button h-8→h-10

### US-034: Fix mobile-specific UI issues
- Dashboard.tsx already has pb-16 for mobile content (increased to pb-20 for US-073)
- Safety badges: removed hidden sm:flex, now visible on all screen sizes

### US-037: Remove DOMPurify style attribute allowance
- Removed 'style' from ALLOWED_ATTR in EmailSequenceBuilder.tsx (2 instances)
- Removed 'style' from ALLOWED_ATTR in EmailTemplateBuilder.tsx (1 instance)

### US-039: Consolidate duplicate touch target CSS rules
- Removed blanket touch target rules from mobile-first.css (lines 14-69) that applied to ALL devices
- Kept @media (pointer: coarse) approach in index.css for touch-only devices
- Removed duplicate .touch-target utility from mobile-first.css
- Removed duplicate TOUCH TARGET SIZE section from index.css (lines 781-799)

### US-050: Add aria-live regions to dynamic content
- Pantry.tsx: Added aria-live="polite" to all 3 view modes (grouped, grid, list)
- Grocery.tsx: Added to progress bar and items container
- Kids.tsx: Added to profiles grid
- Planner.tsx: Added to mobile and desktop meal plan displays
- Verified sonner Toaster already provides aria-live

### US-051: Replace placeholder Index page
- Already complete: "/" route renders Landing directly in App.tsx
- Index.tsx was never imported (orphan file)

### US-052: Add trust signals to Pricing page
- Added 30-day money-back guarantee banner with ShieldCheck icon
- Added trust signals grid: Cancel anytime, No contracts, SSL, 2000+ families
- Added Billing FAQ accordion with 5 questions using shadcn Accordion
- Removed custom BillingFaqItem in favor of shadcn Accordion

### US-053: Add cross-page internal linking for lead magnets
- Already complete: Landing page has Free Tools link in both desktop and mobile nav
- Free Tools section already has id="free-tools"

### US-054: Add newsletter email capture
- Created src/components/NewsletterSignup.tsx with email input, Supabase submission, success state
- Added to Blog.tsx above article grid
- Added to BlogPost.tsx after article content

### US-055: Add contextual CTA after Blog post content
- Added gradient CTA section in BlogPost.tsx with "Start Free Trial" and "Take the Picky Eater Quiz" buttons

### US-056: Add quiz intro section
- Added intro/overview section to PickyEaterQuiz.tsx with benefits grid (2 min, personality type, strategies, food suggestions)
- Added showIntro state to toggle between intro and quiz

### US-057: Add search and category filtering to FAQ page
- Added search input with real-time filtering
- Added category filter buttons: All, Getting Started, Features, Billing, Technical
- Added category field to each FAQ item
- Added "No results" message

### US-059: Add guided onboarding flow
- Created src/components/OnboardingProgressBar.tsx with 4-step progress tracking
- Steps: Create child profile, Add 5+ safe foods, Generate meal plan, Create grocery list
- Dismissible via X button, stored in localStorage
- Lazy-loaded in Home.tsx

### US-060: Add streak counter to Dashboard Home
- Added streak calculation from planEntries with consecutive day counting
- Displays streak card with Flame icon and contextual messages

### US-062: Add social proof to Auth page sign-up
- Added mobile-only testimonial section above sign-up form
- Shows "Trusted by 2,000+ parents" and quote from Sarah M.

### US-063: Add reading progress bar to Blog post page
- Added thin 3px progress bar fixed at top of viewport
- Calculates scroll percentage via scroll event listener
- Added "About the Author" section after article content

### US-065: Add expected response time to Contact page
- Added "We respond within 24 hours" badge at top
- Replaced generic Subject input with Select dropdown (7 categories)
- Added "What happens next?" process steps section
- Added "Check our FAQ first" nudge linking to /faq

### US-066: Show food safety badges on mobile in PantryListItem
- Changed badges from hidden sm:flex to flex (visible all screens)
- Reduced padding on mobile (px-1 sm:px-1.5)

### US-068: Add keyboard shortcut help modal
- Created src/components/KeyboardShortcutsModal.tsx with ? key trigger
- Lists Navigation and Actions shortcut categories
- Added to Dashboard.tsx desktop header

### US-069: Add contextual tooltips to dashboard stats cards
- Added tooltip prop to AnimatedDashboard stat cards
- Added CircleHelp icons with descriptive tooltips for Safe Foods, Try Bites, Meals Planned, Grocery Items

### US-070: Add 404 page improvements
- Enhanced NotFound.tsx with search input, popular page links, Back to home button
- Added noindex meta tag and analytics tracking

### US-073: Add persistent bottom safe-area padding
- Changed Dashboard.tsx mobile content from pb-16 to pb-20

### US-074: Add Grocery list progress percentage
- Added percentage text: "8 of 12 items (67%)"
- Added milestone messages at 25/50/75/100%

### US-075: Add child profile completion indicator
- Added profile completion calculation (name, age, allergens, safe foods, preferences)
- Shows progress bar and "Profile X% complete" text
- Shows "Complete Profile" link when under 80%

### Build Verification
- `npx tsc --noEmit`: SUCCESS (zero TypeScript errors)
- `npx vite build`: SUCCESS (built in 1m 5s)

### Progress Summary
- 29 stories completed this session
- Total: 50/75 stories now passing
- Remaining: 25 stories with passes: false
---
